<!DOCTYPE html>
<html lang="en">
<head>
	<title>Pension Calculator</title>
	<link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/bootstrap-icons.css">
	<link rel="stylesheet" href="./css/style.css">
</head>

<body>
	<header class="p-1 mb-2 bg-info text-white shadow">
		<div class="container">
		  <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
			<ul class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
			  <li><a href="index.html" class="nav-link px-2 text-white">Home</a></li>
			  <li><a href="pension.html" class="nav-link px-2 text-white">Pension Calculator</a></li>
			  <li><a href="edli.html" class="nav-link px-2 text-white">EDLI</a></li>
			</ul>
			<h3 class="text-center">CALCULATOR</h3>
		  </div>
		</div>
	</header>
    <div class="container-fluid" ng-app="pensionApp" ng-controller="pensionCtrl">
		<div class="row">
			<div class="alert fade show" role="alert">
			<ul class="list-group">
				<li  class="list-group-item list-group-item-danger"><i class="bi bi-exclamation-octagon-fill"></i>
					The calculations shown here are only illustrative in nature and can not be used as a basis of any legal case/litigation.
				</li>
			</ul>
			</div>
		</div>
		<div class="row g-4">
			<div class="col-sm-12">
				<div class="card shadow">
					<div class="card-header">Pension Calculator Input</div>
					<div class="card-body">
						<form>
							<div class="input-group mb-3">
								<span class="input-group-text col-5" id="basic-addon1">DOB: </span>
								<input type="date" ng-model="basic.dob" class="form-control" placeholder="dob" aria-label="dob" aria-describedby="basic-addon1">
							</div>
						</form>
						<table class="table table-striped table-bordered table-sm">
							<thead>
								<tr>
									<td>DOJ</td>
									<td>DOE</td>
									<td>NCP1</td>
									<td>NCP2</td>
									<td></td>
								</tr>
							</thead>
							<tbody>
								<tr ng-repeat="service in services">
									<td>{{service.doj |  date:'dd-MM-yyyy'}}</td>
									<td>{{service.doe |  date:'dd-MM-yyyy'}}</td>
									<td>{{service.ncp1}}</td>
									<td>{{service.ncp2}}</td>
									<td><i class="bi bi-trash" ng-click='removeService($index)'></i></td>
								</tr>
							</tbody>
						</table>
						<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addService"><i class="bi bi-plus-circle-fill"></i> Add Service</button>			
						<br/><br/>
						
					</div>
					<div class="card-footer">
						<ul class="list-group mb-3 shadow">
							<li class="list-group-item list-group-item d-flex justify-content-between align-items-center">Total: <span>{{services.length}} services</span></li>
							<li class="list-group-item list-group-item-warning" ng-show="eligibilityMsg"><i class="bi bi-exclamation-octagon-fill"></i> {{"Information: "+ eligibilityMsg}}</li>
							<li class="list-group-item list-group-item-warning" ng-if="actual_service"><i class="bi bi-exclamation-octagon-fill"></i> Your Actual service is: {{actual_service}} days</li>
							<li class="list-group-item list-group-item-warning" ng-if="eligible_service"><i class="bi bi-exclamation-octagon-fill"></i> Your eligible service is: {{eligible_service}} days</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<div class="row mt-3">
			<div class="col">
				
			</div>
		</div>
<div class="modal fade" id="addService" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="addService" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
		<div class="modal-header">
			<h5 class="modal-title" id="addService">Add Service</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		</div>
		<div class="modal-body">
			<form>
					<div class="input-group mb-3 bg-info">
						<span class="input-group-text col-6">DOJ</span>
						<input type="date" ng-model ="service_input.doj" class="form-control" placeholder="doj" aria-label="doj">
					</div>
					<div class="input-group mb-3 bg-light">
						<span class="input-group-text col-6">DOE</span>
						<input type="date" ng-model ="service_input.doe" class="form-control" placeholder="doe" aria-label="doe">
					</div>
					<div class="input-group mb-3 bg-light">
						<span class="input-group-text col-6">NCP b/w 16-11-1995 to 31-08-2014</span>
						<input type="number" ng-model ="service_input.ncp1" class="form-control" placeholder="NCP1" aria-label="NCP1">
					</div>
					<div class="input-group mb-3 bg-light">
						<span class="input-group-text col-6">NCP from 01-09-2014</span>
						<input type="number" ng-model ="service_input.ncp2" class="form-control" placeholder="NCP2" aria-label="NCP2">
					</div>
					<div class="row mb-3">
						<div class="col-3">
							<button type="button" class="btn btn-success waves-effect" ng-click="addService()" data-bs-dismiss="modal"><i class="bi bi-plus-circle-fill"></i> Add Service</button>
						</div>
					</div>
			</form>
		</div>
    </div>
  </div>
</div>
	<!--
	container fluid div closer
	-->
	</div>
	<script type="text/javascript" src="./script/angular.min.js"></script>
	<script type="text/javascript" src="./script/angular-cookies.js"></script>
	<script type="text/javascript" src="./script/angular-route.js"></script>
	<script type="text/javascript" src="./script/jquery-3.3.1.slim.min.js"></script>
	<script type="text/javascript" src="./script/popper.min.js"></script>
	<script type="text/javascript" src="./script/bootstrap.bundle.min.js"></script>
	<script type="text/javascript" src="./script/luxon.min.js"></script>
	<script type="text/javascript" src="./script/lodash.min.js"></script>
	<script type="text/javascript" src="./script/qrcode.min.js"></script>
	<!--<script type="text/javascript" src="./script/script.js"></script>-->
	<script>
const MIN = 1000;
const CEILING1 = 6500;
const CEILING2 = 15000;
const CEILING1_DATE = new Date('1995-11-16');
const CEILING2_DATE = new Date('2014-09-01');	
const BASIC_DEFAULT = {
	'dob': luxon.DateTime.fromJSDate(new Date()).minus({years: 58}).toJSDate(),
	'doe': new Date(),
}

const SERVICE_INPUT_DEFAULT = {
	'doj': new Date('1995-11-16'),
	'doe': new Date('2018-12-01'),
	'ncp1':8,
	'ncp2':46
}

const SERVICE_DEFAULT = {
	'actual':0,
	'eligible': 0,
	'eligible1':0,
	'months1': 0,
	'months2': 0,
	'avg_wage1':CEILING1,
	'avg_wage2':CEILING2,
	'ncp1':0,
	'ncp2':0,
	'days95':0,
	'total_ncp':0,
	'wage95':0,
	'factor':0,
	'past_pension':0
}

const SUPERANNUATION_DEFAULT = {
	"total_month_psal":60,
	"total_wage_psal":597247,
	"total_ncp_psal":0,
	"weightage":0,
	"eligible":0,
	"eligible_WB":0,
	"min":0,
	"pservice":0,
	"psalary":15000,
	"pension1":0,
	"pension2":0,
	"pension3":0,
	"last_wage":15000,
	'greater':1
}

const TOTAL_DEFAULT = {
	'doj':new Date(),
	'doe':new Date(),
	'ncp1':0,
	'ncp2':0,
	'monthsbefore':0,
	'monthsafter':0,
	'daysbefore':0,
	'daysafter':0
}

function getDays (date1, date2, withEndDate=1) {
	var interval = luxon.Interval.fromDateTimes(date1, date2);
	var date1_modified = date1.plus({
		months: Math.floor(interval.length('Months'))
		});
	var interval2 = luxon.Interval.fromDateTimes(date1_modified, date2);
	return (
			(Math.floor(interval.length('Years'))*365)+
			(Math.floor(interval.length('Months')%12)*30)+
			interval2.length('Days')+
			withEndDate
			);
}

function getDifference(d1, d2, unit="Days", period="both", withEndDate=1) {
	//date1 is initial date
	//date2 is final date
	//unit is unit which is to be used for finding the difference
	//period both=total, before=Before 01-09-2014, after=after 2014
	//withEndDate 1=true, 0=false
	//return -1 if any error
	
	if(period=="before" && d2>CEILING2_DATE) {
		d2= new Date('2014-08-31');
		if(d1<CEILING2_DATE) d1=CEILING1_DATE;
	} else if(period=="after" && d1<CEILING2_DATE) {
		d1= CEILING2_DATE;
	}
	date1= luxon.DateTime.fromJSDate(d1);
	date2= luxon.DateTime.fromJSDate(d2);
	var interval = luxon.Interval.fromDateTimes(date1, date2);
	if (interval.invalid || !['Years','Months','Days'].includes(unit) || !["both","before","after"].includes(period) || ![0,1].includes(withEndDate)){
		log("getDifference: Error:",["Invalid Input"])
		return -1;
	} else {
		log("getDifference:",[date1,date2,unit,period,withEndDate]);
	}
	
	if(unit=="Days") {
		return getDays (date1, date2, withEndDate);
	} else if (unit=="Years" || unit=="Months") {
		interval = luxon.Interval.fromDateTimes(date1, date2.plus({'days':1}));
		return Math.floor(interval.length(unit));
	} 
	return -1;
}
function log(str, array) {
	console.log("Log:", str,":")
	let text = array.join();
	if(array.length) console.log(text);
}

function dateRangeOverlaps(a_start, a_end, b_start, b_end) {
	if (a_start <= b_start && b_start <= a_end) return true; // b starts in a
	if (a_start <= b_end   && b_end   <= a_end) return true; // b ends in a
	if (b_start <  a_start && a_end   <  b_end) return true; // a in b
	return false;
}

function multipleDateRangeOverlaps(dates) {
	var i, j;
	if (dates.length % 2 !== 0)
		throw new TypeError('Arguments length must be a multiple of 2');
	for (i = 0; i < dates.length - 2; i += 2) {
		for (j = i + 2; j < dates.length; j += 2) {
			if (
				dateRangeOverlaps(
					dates[i], dates[i+1],
					dates[j], dates[j+1]
				)
			) return true;
		}
	}
	return false;
}

var app = angular.module('pensionApp', ['ngCookies']);
app.controller('pensionCtrl', ['$scope','$cookies','$cookieStore', '$http', function($scope,$cookies,$cookieStore, $http) {
	
	$scope.removeService = function(index) {
		if(index >= 0){
			//$scope.dates.splice(index*2, 2);
			$scope.services.splice(index, 1);
			$scope.update();	
		}
	}
	
	$scope.update = function() {
		log("update called",[])
		$scope.total=getTotal();
		$scope.updateBasic();
		updateEligibility();		
		$scope.update_Superannuation();
	}
	
	$scope.reset = function () {
		$scope.dates=[];
		$scope.services=[];
		$scope.service = SERVICE_DEFAULT;
		$scope.service_input  = SERVICE_INPUT_DEFAULT;
		$scope.pension = SUPERANNUATION_DEFAULT;
		$scope.total=TOTAL_DEFAULT;
		$scope.basic = BASIC_DEFAULT;
		$scope.update()
	}
	
	function getTotal() {
	}
	
	function updateEligibility(){
	}
	
	$scope.updateBasic = function(){
		
	}
	
	$scope.update_Superannuation = function(){
	}
	
	$scope.addService = function(){
		
		var doj = $scope.service_input.doj;
		var doe = $scope.service_input.doe;
		var ncp1 = $scope.service_input.ncp1;
		var ncp2 = $scope.service_input.ncp2;
		log("Add Service Called: (DOJ, DOE): ",[doj,doe]);
		var date1 = $scope.dates.slice();
		$scope.dates.push(doj);
		$scope.dates.push(doe);
		
		if(multipleDateRangeOverlaps($scope.dates)){
			alert("Date range overlapping. Returning to previous state");
			$scope.dates = date1.slice();
		} else if (doj>doe) {
			alert("DOJ can not be later than DOE. Returning to previous state");
			$scope.dates = date1.slice();
		} else if (doj<$scope.basic.dob) {
			alert("DOJ can not be earlier than DOB. Returning to previous state");
			$scope.dates = date1.slice();
		} else if (doj<CEILING1_DATE) {
			alert("DOJ can not be less than 16-11-1995.Returning to previous state.");
			$scope.dates = date1.slice();
		} else if(getDifference(doj,doe,'Days',"before")<ncp1 || getDifference(doj,doe,'Days')<(ncp1+ncp2) || getDifference(doj,doe,'Days',"after")<ncp2){
			log("NCP mismatch",[getDifference(doj,doe,'Days',"before"),getDifference(doj,doe,'Days')<(ncp1+ncp2),getDifference(doj,doe,'Days',"after")]);
			alert("NCP can not be more than service days.Returning to previous state.");
			$scope.dates = date1.slice();
		} else {
			var service = {
				'doj':doj,
				'doe':doe,
				'ncp1':ncp1,
				'ncp2':ncp2,
				'monthsbefore':getDifference(doj,doe,'Months',"before"),
				'monthsafter':getDifference(doj,doe,'Months',"after"),
				'yearsbefore':getDifference(doj,doe,'Years',"before"),
				'yearsafter':getDifference(doj,doe,'Years',"after"),
				'daysbefore':getDifference(doj,doe,'Days',"before"),
				'daysafter':getDifference(doj,doe,'Days',"after")
				
			}
			$scope.basic.doe=doe>$scope.basic.doe?doe:$scope.basic.doe;
			service['daystotal']=service['daysbefore']+service['daysafter'];
			console.log(service);
			log("addService:(daysbefore, daysafter, daystotal,ncp1,ncp2):",[service['daysbefore'],service['daysafter'],service['daystotal'],ncp1,ncp2])
			$scope.services.push(service);
			$scope.update();	
		}
	}
	
	$http({
		method: 'GET',
		url: './data.json'
	}).then(function (success){
		log("json downloaded",[]);
		TABLEB = success.data.TABLEB;	
		TABLEC = success.data.TABLEC;
		TABLED = success.data.TABLED;
		TABLE_BASIC = success.data.TABLE_BASIC_PENSION;
		$scope.reset();
	},function (error){
		log(error,[])
	});
}]);
	</script>
</body>
</html>