<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Havannah Game</title>
    <style>
        canvas {
            border: 1px solid black;
        }

        #currentTurn {
            font-size: 20px;
            margin-bottom: 10px;
        }

        #game-info {
            margin-bottom: 10px;
        }

        #winner {
            font-size: 24px;
            color: green;
        }
    </style>
</head>
<body>
    <div id="game-info">
        <label for="sizeSelect">Select Board Size:</label>
        <select id="sizeSelect">
            <option value="4">4</option>
            <option value="6">6</option>
            <option value="8">8</option>
        </select>
        
        <!-- Dropdown to choose Player 2 (Human or AI) -->
        <label for="player2Type">Player 2:</label>
        <select id="player2Type">
            <option value="human">Human</option>
            <option value="ai">AI</option>
        </select>
        
        <button id="startGameBtn">Start Game</button>
    </div>

    <div id="gameStatus">
        <div id="currentTurn">Current Turn: </div>
        <div>Player 1 (Yellow) Time Remaining: <span id="player1Time">5:00</span></div>
        <div>Player 2 (Red) Time Remaining: <span id="player2Time">5:00</span></div>
        <div id="winner"></div> <!-- Show who won -->
    </div>

    <canvas id="gameCanvas" width="600" height="600"></canvas>

    <script src="helper.js"></script> <!-- Include helper.js -->
    <script src="ai.js"></script> <!-- Include ai.js for AI functionality -->

    <script>
        let canvas = document.getElementById('gameCanvas');
        let context = canvas.getContext('2d');
        let layers;
        let currentPlayer = 0; // 0 -> Player 1, 1 -> Player 2
        let playerTime = [300, 300]; // 5 minutes for each player in seconds
        let gameOver = false;
        let board;
        let intervalId;
        let hexSize = 40;
        let aiPlayer = null; // AI Player 2 object
        let isPlayer2AI = false; // Flag to determine if Player 2 is AI

        document.getElementById('startGameBtn').addEventListener('click', startGame);

        function startGame() {
            layers = parseInt(document.getElementById('sizeSelect').value);
            board = createInitialBoard(layers);
            currentPlayer = 0;
            gameOver = false;
            playerTime = [300, 300];
            document.getElementById('winner').textContent = '';
            document.getElementById('currentTurn').textContent = 'Current Turn: Player 1';
            drawBoard(board);
            if (intervalId) clearInterval(intervalId);
            intervalId = setInterval(updateTimer, 1000); // Update timer every second

            // Determine if Player 2 is AI or human
            isPlayer2AI = document.getElementById('player2Type').value === 'ai';
            if (isPlayer2AI) {
                aiPlayer = new AIPlayer(2); // Initialize AI for Player 2
            }
        }

        function createInitialBoard(layers) {
            const board = [];
            for (let i = 0; i < 2 * layers - 1; i++) {
                const row = [];
                for (let j = 0; j < 2 * layers - 1; j++) {
                    row.push(0); // 0 represents empty cell
                }
                board.push(row);
            }
            return board;
        }

        function drawBoard(board) {
            context.clearRect(0, 0, canvas.width, canvas.height);
            for (let j = 0; j < 2 * layers - 1; j++) {
                const colSize = j < layers ? layers + j : layers + 2 * layers - 2 - j;
                for (let i = 0; i < colSize; i++) {
                    const hexCoords = calculateHexagon(i, j);
                    const color = board[i][j] === 1 ? 'yellow' : (board[i][j] === 2 ? 'red' : 'white');
                    drawHexagon(hexCoords, color, i, j);
                }
            }
        }

        function calculateHexagon(i, j) {
            const sqrt3 = Math.sqrt(3);
            const offsetX = j * hexSize * 3 / 2;
            const offsetY = (Math.abs(j - layers + 1) + 2 * i) * hexSize * sqrt3 / 2;
            return [
                { x: (hexSize / 2 + offsetX), y: offsetY },
                { x: (hexSize * 3 / 2 + offsetX), y: offsetY },
                { x: (hexSize * 2 + offsetX), y: (hexSize * sqrt3 / 2 + offsetY) },
                { x: (hexSize * 3 / 2 + offsetX), y: (hexSize * sqrt3 + offsetY) },
                { x: (hexSize / 2 + offsetX), y: (hexSize * sqrt3 + offsetY) },
                { x: offsetX, y: (hexSize * sqrt3 / 2 + offsetY) },
            ];
        }

        function drawHexagon(coords, fillColor, row, col) {
            context.beginPath();
            context.moveTo(coords[0].x, coords[0].y);
            coords.forEach(point => context.lineTo(point.x, point.y));
            context.closePath();
            context.fillStyle = fillColor || 'white';
            context.fill();
            context.stroke();

            const centroid = calculateCentroid(coords);
            context.fillStyle = 'black';
            context.font = '12px Arial';
            context.fillText(`(${row},${col})`, centroid.x - 10, centroid.y + 4);
        }

        function calculateCentroid(coords) {
            let centroidX = 0, centroidY = 0;
            coords.forEach(point => {
                centroidX += point.x;
                centroidY += point.y;
            });
            return { x: centroidX / coords.length, y: centroidY / coords.length };
        }

        function updateTimer() {
            if (gameOver) return;
            playerTime[currentPlayer]--;
            if (playerTime[currentPlayer] <= 0) {
                gameOver = true;
                document.getElementById('currentTurn').textContent = `Game Over! Player ${currentPlayer + 1} ran out of time.`;
                clearInterval(intervalId);
                return;
            }
            updatePlayerTime();
        }

        function updatePlayerTime() {
            const player1Min = Math.floor(playerTime[0] / 60);
            const player1Sec = playerTime[0] % 60;
            const player2Min = Math.floor(playerTime[1] / 60);
            const player2Sec = playerTime[1] % 60;
            document.getElementById('player1Time').textContent = `${player1Min}:${player1Sec < 10 ? '0' : ''}${player1Sec}`;
            document.getElementById('player2Time').textContent = `${player2Min}:${player2Sec < 10 ? '0' : ''}${player2Sec}`;
        }

        canvas.addEventListener('click', (event) => {
            if (gameOver || (currentPlayer === 1 && isPlayer2AI)) return; // Skip human clicks if it's AI's turn

            const x = event.offsetX;
            const y = event.offsetY;

            const [row, col] = getHexagonAtCoords(x, y);
            if (row !== null && col !== null && board[row][col] === 0) {
                makeMove(row, col);
            }
        });

        function getHexagonAtCoords(x, y) {
            for (let r = 0; r < 2 * layers - 1; r++) {
                for (let c = 0; c < 2 * layers - 1; c++) {
                    const hexCoords = calculateHexagon(r, c);
                    if (isPointInHexagon(x, y, hexCoords)) {
                        return [r, c];
                    }
                }
            }
            return [null, null];
        }

        function isPointInHexagon(x, y, coords) {
            let inside = false;
            for (let i = 0; i < coords.length; i++) {
                const j = (i + 1) % coords.length;
                const xi = coords[i].x, yi = coords[i].y;
                const xj = coords[j].x, yj = coords[j].y;

                const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) inside = !inside;
            }
            return inside;
        }

        function switchPlayer() {
            currentPlayer = 1 - currentPlayer;
            document.getElementById('currentTurn').textContent = `Current Turn: Player ${currentPlayer + 1}`;
            if (currentPlayer === 1 && isPlayer2AI && !gameOver) {
                handleAITurn(); // AI makes a move
            }
        }

        function makeMove(row, col) {
            board[row][col] = currentPlayer + 1; // Player 1 is Yellow, Player 2 is Red
            drawBoard(board);

            const [win, structure] = checkWin(board, [row, col], currentPlayer + 1);
            if (win) {
                endGame(currentPlayer + 1, structure);
            } else {
                switchPlayer();
            }
        }

        function handleAITurn() {
            setTimeout(() => {
                const aiMove = aiPlayer.getMove(board);
                makeMove(aiMove[0], aiMove[1]);
            }, 500); // Slight delay to mimic AI thinking
        }

        function endGame(winner, structure) {
            gameOver = true;
            document.getElementById('currentTurn').textContent = `Game Over! Player ${winner} wins by ${structure}!`;
        }

    </script>
</body>
</html>
